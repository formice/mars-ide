<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>富文本编辑器</title>
	<link rel="stylesheet" href="../../component/layui/css/layui.css" />
	<link rel="stylesheet" href="../../admin/css/pearForm.css" />
    <script type="text/javascript" src="../../js/common/base.js"></script>
  <style>
    body{margin: 10px;
	background-color: whitesmoke;}

    .layui-col-md6 {
      width: 100%;
    }

    .ef-node-form-header {
      height: 32px;
      border-top: 1px solid #dce3e8;
      border-bottom: 1px solid #dce3e8;
      background: #f1f3f4;
      color: #000;
      line-height: 32px;
      padding-left: 12px;
      font-size: 14px;
      margin-left:2px;
      margin-right: 2px;
    }
  </style>
</head>
<body>
  <div >
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md6" id="card-tool">
        <div class="layui-card">
          <!--<div class="layui-card-header">名称：</div>-->
          <div class="layui-card-body layui-row layui-col-space10">
            <div class="layui-col-lg6">
              <label class="layui-form-label">任务名称：</label>
              <div class="layui-input-block">
                <input type="text" id="name" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
              </div>
            </div>
          </div>
        </div>
        <!--<div class="layui-card">
          <div class="layui-card-header">工具名称：bwa index</div>

          <div class="ef-node-form-header">输入</div>
          <div class="layui-card-body">
              <div class="layui-row layui-col-space10 layui-form-item">
                <div class="layui-col-lg6">
                  <label class="layui-form-label">员工姓名1：</label>
                  <div class="layui-input-block">
                    <input type="text" name="fullname" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
                  </div>
                </div>

                <div class="layui-col-lg6">
                  <label class="layui-form-label">员工姓名2：</label>
                  <div class="layui-input-block">
                    <input type="text" name="fullname" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
                  </div>
                </div>
              </div>

          </div>

          <div class="ef-node-form-header">输出</div>
          <div class="layui-card-body">
              <div class="layui-row layui-col-space10 layui-form-item">
                <div class="layui-col-lg6">
                  <label class="layui-form-label">员工姓名：</label>
                  <div class="layui-input-block">
                    <input type="text" name="fullname" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
                  </div>
                </div>
              </div>
          </div>
        </div>-->



      </div>
    </div>
  </div>
 
<script src="../../component/layui/layui.js"></script>
<script>

    layui.use(['util', 'layer','form'], function () {
        

        var util = layui.util;

        var form = layui.form;

        var $ = layui.jquery;

        /*var edit = tinymce.render({
            elem: "#edit"
            , height: 400
        });*/

        util.event('lay-event', {
            getContent: function () {
                console.log(edit.getContent())
                layer.msg("展开控制台查看")
            }
        });

      loadToolConfig();

      function loadToolConfig(){
        //初始化每个工具的参数
        $.ajax({
          url:'http://localhost:8080/flow/tool/config?flowId='+getQueryVariable("flowId"),
          method:'post',
          //data:data.field,
          dataType:'JSON',
          success:function(res){
            if(res.code='200'){
              console.log(res);

              var data = res.data;
              //遍历工具
              $.each(data,function(key,values){
                var toolArr = key.split("@*-*@");
                var toolId = toolArr[0];
                var toolName = toolArr[1];
                $('#card-tool').append("<div class=\"layui-card\" id=\"layui-card-"+toolId+"\">"+
                        "<div class=\"layui-card-header\">工具名称："+toolName+"</div>");
                //遍历参数类别
                $.each(values,function(key,value){
                  var cate = key;
                  if(cate == 'inputs'){
                    cate = "输入";
                  }else if(cate =='outputs'){
                    cate = "输出";
                  }else if(cate == 'params'){
                    return;
                  }
                  $('#card-tool >  #layui-card-'+toolId+'').append("<div class=\"ef-node-form-header\">"+cate+"</div>");
                  $('#card-tool >  #layui-card-'+toolId+'').append("<div class=\"layui-card-body\" id=\"layui-card-body-"+toolId+"-"+cate+"\">\n");
                  $('#card-tool >  #layui-card-'+toolId+' > #layui-card-body-'+toolId+'-'+cate).append(
                          "              <div class=\"layui-row layui-col-space10 layui-form-item\" id=\"layui-row-"+toolId+"\">\n");
                  //遍历具体参数值
                  for(var index in value){
                    var name = value[index].name;
                    var id = value[index].id;
                    var defaultValue = value[index].defaultValue == undefined ? '' : value[index].defaultValue;
                    var type = 0;
                    if(cate == '输入'){
                      type = 16;
                    }else if(cate =='输出'){
                      type = 17;
                    }else if(cate == 'params'){
                      type = 18;
                    }

                    $('#card-tool >  #layui-card-'+toolId+' > #layui-card-body-'+toolId+'-'+cate+' > #layui-row-'+toolId+'').append(
                            "                <div id=\"run-"+id+"\" class=\"layui-col-lg6\">\n"+
                            "                 <input type=\"hidden\" id=\"run-id-"+id+"\" value=\""+id+"\" required=\"\" lay-verify=\"required\" autocomplete=\"off\" >\n" +
                            "                 <input type=\"hidden\" id=\"run-toolId-"+toolId+"\" value=\""+toolId+"\" required=\"\" lay-verify=\"required\" autocomplete=\"off\">\n" +
                            "                 <input type=\"hidden\" id=\"run-type-"+type+"\" value=\""+type+"\" required=\"\" lay-verify=\"required\" autocomplete=\"off\">\n" +
                            "                  <label class=\"layui-form-label\">"+name+"：</label>\n" +
                            "                  <div class=\"layui-input-block\">\n" +
                            "                    <input type=\"text\" id=\"run-value-"+id+"\" lay-verify=\"required\" placeholder=\"\" autocomplete=\"off\" class=\"layui-input\">\n" +
                            "                  </div>\n" +
                            "                </div>\n"
                            );
                  }
                  $('#card-tool >  #layui-card-'+toolId+'').append("</div>");
                  $('#card-tool >  #layui-card-'+toolId+' > #layui-card-body-'+toolId+'-'+cate).append("</div>");
                });
                $('#card-tool').append("</div>");
              });

              $('#card-tool').append("<div class=\"layui-form-item\" style=\"text-align: center\">\n" +
                      "          <div class=\"layui-input-block\">\n" +
                      "            <button id=\"run1\" class=\"layui-btn layui-btn-normal\" lay-submit lay-filter=\"component-form-element\">立即运行</button>\n" +
                      "          </div>\n" +
                      "        </div>");


            } else {
              alert(res.msg);
            }
          },
          error:function (data) {

          }
        }) ;
      }

      $("body").on('click', '#run1',function () {
            var jsonObj = {};
            jsonObj.name = $('#name').val();
            jsonObj.flowId = getQueryVariable("flowId");


            //构建参数
            var runArr = [];
            $("div[id^='run-']").each(function () {
            var run = {};

            run.id = $(this).find("input[id^='run-id-']").val();
            run.toolId = $(this).find("input[id^='run-toolId-']").val();
            run.type = $(this).find("input[id^='run-type-']").val();
            run.value = $(this).find("input[id^='run-value-']").val();
            runArr.push(run);
          });
          jsonObj.run = runArr;
          alert(JSON.stringify(jsonObj));




          $.ajax({
            url: 'http://localhost:8080/flow/run',
            method: 'post',
            contentType: 'application/json', //需要加contentType
            data: JSON.stringify(jsonObj),
            dataType: 'JSON',
            success: function (res) {
              if (res.code = '200') {
                console.log(res);
                //发异步，把数据提交给php
                layer.alert("增加成功", {
                          icon: 6
                        },
                        function () {
                          var url = "flow-list.html";//此处拼接内容
                          window.location.href = url;
                        });
              } else {
                alert(res.msg);
              }
            },
            error: function (data) {

            }
          });
    });


    });
</script>
</body>
</html>        